#!/bin/bash

# ====== à¸„à¹ˆà¸²à¸žà¸·à¹‰à¸™à¸à¸²à¸™ ======
UUID=$(uuidgen)
PORT=443
FAKE_HOST="www.speedtest.net"
CONFIG_PATH="/usr/local/etc/v2ray"
BIN_NAME="v2rayx"

echo "ðŸ”§ à¸à¸³à¸¥à¸±à¸‡à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ V2Ray-core à¹à¸šà¸š vless+tcp+no tls (ping à¸•à¹ˆà¸³)"

# ====== à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ v2ray-core ======
apt update -y
apt install curl unzip -y

echo "ðŸ“¥ à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” v2ray-core..."
LATEST_URL="https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-64.zip"
curl -L -o /tmp/v2ray.zip "$LATEST_URL"
curl -L -o /tmp/v2ray.zip.dgst "${LATEST_URL}.dgst"

unzip /tmp/v2ray.zip -d /tmp/v2ray

# à¸¢à¹‰à¸²à¸¢à¹„à¸Ÿà¸¥à¹Œà¹„à¸›à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡
install -m 755 /tmp/v2ray/v2ray /usr/local/bin/$BIN_NAME
install -d /usr/local/share/v2ray
install -m 644 /tmp/v2ray/geo* /usr/local/share/v2ray/

# ====== à¸ªà¸£à¹‰à¸²à¸‡ config.json ======
mkdir -p $CONFIG_PATH
cat > $CONFIG_PATH/config.json <<EOF
{
  "inbounds": [{
    "port": $PORT,
    "protocol": "vless",
    "settings": {
      "clients": [{
        "id": "$UUID",
        "level": 0,
        "email": "user@example.com"
      }],
      "decryption": "none"
    },
    "streamSettings": {
      "network": "tcp",
      "security": "none",
      "tcpSettings": {
        "header": {
          "type": "http",
          "request": {
            "headers": {
              "Host": ["$FAKE_HOST"]
            }
          }
        }
      }
    }
  }],
  "outbounds": [{
    "protocol": "freedom"
  }]
}
EOF

# ====== à¸ªà¸£à¹‰à¸²à¸‡ systemd service ======
cat > /etc/systemd/system/v2ray.service <<EOF
[Unit]
Description=V2RayX Service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/$BIN_NAME run -config $CONFIG_PATH/config.json
Restart=on-failure
User=nobody
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF

# ====== à¸—à¸³à¸„à¸§à¸²à¸¡à¸ªà¸°à¸­à¸²à¸” ======
rm -rf /tmp/v2ray*

# ====== à¸ªà¸£à¸¸à¸› ======
IP=$(curl -s ipv4.icanhazip.com)
echo ""
echo "âœ… à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ V2Ray-core (v2rayx) à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢ à¹à¸•à¹ˆà¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸£à¸´à¹ˆà¸¡à¸£à¸±à¸™"
echo "ðŸŒ IP: $IP"
echo "ðŸ”‘ UUID: $UUID"
echo "ðŸ“¡ Port: $PORT"
echo "ðŸ”° Fake Host: $FAKE_HOST"
echo ""
echo "ðŸ”— à¸¥à¸´à¸‡à¸à¹Œ VLESS:"
echo "vless://$UUID@$IP:$PORT?type=tcp&security=none&path=/%2F&host=$FAKE_HOST&headerType=http#v2rayx"
echo ""
echo "ðŸ“Œ à¹€à¸¡à¸·à¹ˆà¸­à¸žà¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™:"
echo "ðŸ‘‰ systemctl start v2ray"
echo "ðŸ‘‰ systemctl enable v2ray"
