#!/bin/bash

# à¸à¸³à¸«à¸™à¸”à¸Šà¸·à¹ˆà¸­
BIN_NAME="v2rayx"
SERVICE_NAME="v2rayx"
CONFIG_PATH="/etc/v2rayx"
UUID=$(cat /proc/sys/kernel/random/uuid)
FAKE_HOST="www.speedtest.net"

# à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ curl, unzip à¸–à¹‰à¸²à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ
apt update -y && apt install curl unzip -y

# à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” V2Ray core à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
mkdir -p /tmp/v2tmp && cd /tmp/v2tmp
curl -Ls https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-64.zip -o v2ray.zip
unzip v2ray.zip

# à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ binary à¹€à¸›à¹‡à¸™à¸Šà¸·à¹ˆà¸­à¹ƒà¸«à¸¡à¹ˆ
install -m 755 v2ray /usr/local/bin/$BIN_NAME
install -m 755 v2ctl /usr/local/bin/v2ctl

# à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ config
mkdir -p $CONFIG_PATH

# à¸ªà¸£à¹‰à¸²à¸‡ config VLESS + TCP + FakeHost
cat > $CONFIG_PATH/config.json <<EOF
{
  "log": {
    "loglevel": "warning"
  },
  "inbounds": [
    {
      "port": 443,
      "protocol": "vless",
      "settings": {
        "clients": [
          {
            "id": "$UUID",
            "level": 0,
            "email": "v2rayx"
          }
        ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "none",
        "tcpSettings": {
          "header": {
            "type": "http",
            "request": {
              "headers": {
                "Host": [
                  "$FAKE_HOST"
                ]
              }
            }
          }
        }
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom"
    }
  ]
}
EOF

# à¸ªà¸£à¹‰à¸²à¸‡ service à¹à¸šà¸šà¹ƒà¸«à¸¡à¹ˆà¸Šà¸·à¹ˆà¸­ v2rayx
cat > /etc/systemd/system/$SERVICE_NAME.service <<EOF
[Unit]
Description=V2RayX Service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/$BIN_NAME run -config $CONFIG_PATH/config.json
Restart=on-failure
User=nobody
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF

# reload systemd
systemctl daemon-reexec
systemctl daemon-reload

# à¹à¸ªà¸”à¸‡ UUID à¹à¸¥à¸°à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™
clear
echo "âœ… à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ V2RayX à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§!"
echo "----------------------------"
echo "ðŸ†” UUID: $UUID"
echo "ðŸŒ Host: $FAKE_HOST"
echo "ðŸ“¦ à¸žà¸­à¸£à¹Œà¸•: 443 (TCP + HTTP FakeHost)"
echo
echo "ðŸ“Œ à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™:"
echo "à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸±à¸™:      systemctl start $SERVICE_NAME"
echo "à¸«à¸¢à¸¸à¸”:          systemctl stop $SERVICE_NAME"
echo "à¸ªà¸–à¸²à¸™à¸°:         systemctl status $SERVICE_NAME"
echo "à¹€à¸›à¸´à¸” auto:     systemctl enable $SERVICE_NAME"
echo "à¸›à¸´à¸” auto:      systemctl disable $SERVICE_NAME"
echo
echo "ðŸ“Ž à¸¥à¸´à¸‡à¸à¹Œà¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ (VLESS URI):"
echo "vless://$UUID@$(curl -s ifconfig.me):443?type=tcp&security=none&headerType=http&host=$FAKE_HOST#v2rayx"
