#!/bin/bash

# กำหนดชื่อ
BIN_NAME="v2rayx"
SERVICE_NAME="v2rayx"
CONFIG_PATH="/etc/v2rayx"
UUID=$(cat /proc/sys/kernel/random/uuid)
FAKE_HOST="www.speedtest.net"

# ติดตั้ง curl, unzip ถ้ายังไม่มี
apt update -y && apt install curl unzip -y

# ดาวน์โหลด V2Ray core ล่าสุด
mkdir -p /tmp/v2tmp && cd /tmp/v2tmp
curl -Ls https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-64.zip -o v2ray.zip
unzip v2ray.zip

# ติดตั้ง binary เป็นชื่อใหม่
install -m 755 v2ray /usr/local/bin/$BIN_NAME
install -m 755 v2ctl /usr/local/bin/v2ctl

# สร้างโฟลเดอร์ config
mkdir -p $CONFIG_PATH

# สร้าง config VLESS + TCP + FakeHost
cat > $CONFIG_PATH/config.json <<EOF
{
  "log": {
    "loglevel": "warning"
  },
  "inbounds": [
    {
      "port": 443,
      "protocol": "vless",
      "settings": {
        "clients": [
          {
            "id": "$UUID",
            "level": 0,
            "email": "v2rayx"
          }
        ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "none",
        "tcpSettings": {
          "header": {
            "type": "http",
            "request": {
              "headers": {
                "Host": [
                  "$FAKE_HOST"
                ]
              }
            }
          }
        }
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom"
    }
  ]
}
EOF

# สร้าง service แบบใหม่ชื่อ v2rayx
cat > /etc/systemd/system/$SERVICE_NAME.service <<EOF
[Unit]
Description=V2RayX Service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/$BIN_NAME run -config $CONFIG_PATH/config.json
Restart=on-failure
User=nobody
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF

# reload systemd
systemctl daemon-reexec
systemctl daemon-reload

# แสดง UUID และคำสั่งใช้งาน
clear
echo "✅ ติดตั้ง V2RayX สำเร็จแล้ว!"
echo "----------------------------"
echo "🆔 UUID: $UUID"
echo "🌐 Host: $FAKE_HOST"
echo "📦 พอร์ต: 443 (TCP + HTTP FakeHost)"
echo
echo "📌 คำสั่งใช้งาน:"
echo "เริ่มรัน:      systemctl start $SERVICE_NAME"
echo "หยุด:          systemctl stop $SERVICE_NAME"
echo "สถานะ:         systemctl status $SERVICE_NAME"
echo "เปิด auto:     systemctl enable $SERVICE_NAME"
echo "ปิด auto:      systemctl disable $SERVICE_NAME"
echo
echo "📎 ลิงก์เชื่อมต่อ (VLESS URI):"
echo "vless://$UUID@$(curl -s ifconfig.me):443?type=tcp&security=none&headerType=http&host=$FAKE_HOST#v2rayx"
