#!/bin/bash

# ====== ค่าพื้นฐาน ======
UUID=$(uuidgen)
PORT=443
FAKE_HOST="www.speedtest.net"
CONFIG_PATH="/usr/local/etc/v2ray"
BIN_NAME="v2rayx"

echo "🔧 กำลังติดตั้ง V2Ray-core แบบ vless+tcp+no tls (ping ต่ำ)"

# ====== ติดตั้ง v2ray-core ======
apt update -y
apt install curl unzip -y

echo "📥 ดาวน์โหลด v2ray-core..."
LATEST_URL="https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-64.zip"
curl -L -o /tmp/v2ray.zip "$LATEST_URL"
curl -L -o /tmp/v2ray.zip.dgst "${LATEST_URL}.dgst"

unzip /tmp/v2ray.zip -d /tmp/v2ray

# ย้ายไฟล์ไปตำแหน่งติดตั้ง
install -m 755 /tmp/v2ray/v2ray /usr/local/bin/$BIN_NAME
install -d /usr/local/share/v2ray
install -m 644 /tmp/v2ray/geo* /usr/local/share/v2ray/

# ====== สร้าง config.json ======
mkdir -p $CONFIG_PATH
cat > $CONFIG_PATH/config.json <<EOF
{
  "inbounds": [{
    "port": $PORT,
    "protocol": "vless",
    "settings": {
      "clients": [{
        "id": "$UUID",
        "level": 0,
        "email": "user@example.com"
      }],
      "decryption": "none"
    },
    "streamSettings": {
      "network": "tcp",
      "security": "none",
      "tcpSettings": {
        "header": {
          "type": "http",
          "request": {
            "headers": {
              "Host": ["$FAKE_HOST"]
            }
          }
        }
      }
    }
  }],
  "outbounds": [{
    "protocol": "freedom"
  }]
}
EOF

# ====== สร้าง systemd service ======
cat > /etc/systemd/system/v2ray.service <<EOF
[Unit]
Description=V2RayX Service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/$BIN_NAME run -config $CONFIG_PATH/config.json
Restart=on-failure
User=nobody
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF

# ====== ทำความสะอาด ======
rm -rf /tmp/v2ray*

# ====== สรุป ======
IP=$(curl -s ipv4.icanhazip.com)
echo ""
echo "✅ ติดตั้ง V2Ray-core (v2rayx) เรียบร้อย แต่ยังไม่เริ่มรัน"
echo "🌐 IP: $IP"
echo "🔑 UUID: $UUID"
echo "📡 Port: $PORT"
echo "🔰 Fake Host: $FAKE_HOST"
echo ""
echo "🔗 ลิงก์ VLESS:"
echo "vless://$UUID@$IP:$PORT?type=tcp&security=none&path=/%2F&host=$FAKE_HOST&headerType=http#v2rayx"
echo ""
echo "📌 เมื่อพร้อมใช้งาน:"
echo "👉 systemctl start v2ray"
echo "👉 systemctl enable v2ray"
