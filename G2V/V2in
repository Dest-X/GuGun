#!/bin/bash

# ---------- CONFIG ----------
UUID="$(cat /proc/sys/kernel/random/uuid)"
PORT=443
FAKE_HOST="www.speedtest.net"
SERVICE_NAME="v2rayx"
INSTALL_DIR="/usr/local/etc/v2ray"
BIN_FILE="/usr/local/bin/v2rayx"
SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"

# ---------- INSTALL FUNCTION ----------
install_v2rayx() {
  echo "\n>> à¸à¸³à¸¥à¸±à¸‡à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ V2RayX..."

  mkdir -p "$INSTALL_DIR"
  cat > "$INSTALL_DIR/config.json" <<EOF
{
  "inbounds": [
    {
      "port": $PORT,
      "protocol": "vless",
      "settings": {
        "clients": [
          {
            "id": "$UUID",
            "level": 0,
            "email": "user@v2rayx"
          }
        ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "none",
        "tcpSettings": {
          "header": {
            "type": "http",
            "request": {
              "headers": {
                "Host": ["$FAKE_HOST"]
              }
            }
          }
        }
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom"
    }
  ]
}
EOF

  curl -Ls -o "$BIN_FILE" https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-64.zip && unzip -o "$BIN_FILE" -d /usr/local/bin/ && chmod +x "$BIN_FILE"

  cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=V2RayX Service
After=network.target

[Service]
ExecStart=$BIN_FILE -config $INSTALL_DIR/config.json
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

  chmod +x "$BIN_FILE"
  systemctl daemon-reexec
  systemctl daemon-reload
  echo "âœ… à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§ UUID: $UUID"
  echo "ðŸ”— à¸¥à¸´à¸‡à¸à¹Œ: vless://$UUID@$(curl -s ipv4.icanhazip.com):$PORT?type=tcp&security=none&host=$FAKE_HOST&headerType=http"
}

# ---------- MENU ----------
while true; do
  clear
  echo "=============================="
  echo "         à¹€à¸¡à¸™à¸¹à¸«à¸¥à¸±à¸             "
  echo "=============================="
  echo "1) à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ V2RayX"
  echo "2) à¹à¸ªà¸”à¸‡ UUID"
  echo "v) à¸ˆà¸±à¸”à¸à¸²à¸£ V2RayX"
  echo "0) à¸­à¸­à¸"
  echo "=============================="
  read -p "à¹€à¸¥à¸·à¸­à¸à¹€à¸¡à¸™à¸¹: " choice

  case "$choice" in
    1)
      install_v2rayx
      read -p "à¸à¸” Enter à¹€à¸žà¸·à¹ˆà¸­à¸à¸¥à¸±à¸šà¹€à¸¡à¸™à¸¹...";;
    2)
      echo "UUID: $UUID"
      read -p "à¸à¸” Enter à¹€à¸žà¸·à¹ˆà¸­à¸à¸¥à¸±à¸šà¹€à¸¡à¸™à¸¹...";;
    v)
      while true; do
        clear
        echo "====== à¸ˆà¸±à¸”à¸à¸²à¸£ V2RayX ======"
        echo "1) à¹€à¸£à¸´à¹ˆà¸¡ v2rayx"
        echo "2) à¸«à¸¢à¸¸à¸” v2rayx"
        echo "3) à¸£à¸µà¸ªà¸•à¸²à¸£à¹Œà¸— v2rayx"
        echo "4) à¸ªà¸–à¸²à¸™à¸° v2rayx"
        echo "5) à¸¥à¸š v2rayx"
        echo "0) à¸à¸¥à¸±à¸šà¹€à¸¡à¸™à¸¹à¸«à¸¥à¸±à¸"
        echo "=========================="
        read -p "à¹€à¸¥à¸·à¸­à¸: " vopt

        case "$vopt" in
          1) systemctl start v2rayx && echo "âœ… à¹€à¸£à¸´à¹ˆà¸¡ v2rayx à¹à¸¥à¹‰à¸§"; sleep 2;;
          2) systemctl stop v2rayx && echo "ðŸ›‘ à¸«à¸¢à¸¸à¸” v2rayx à¹à¸¥à¹‰à¸§"; sleep 2;;
          3) systemctl restart v2rayx && echo "ðŸ” à¸£à¸µà¸ªà¸•à¸²à¸£à¹Œà¸— v2rayx à¹à¸¥à¹‰à¸§"; sleep 2;;
          4) systemctl status v2rayx --no-pager; read -p "à¸à¸” Enter à¹€à¸žà¸·à¹ˆà¸­à¸à¸¥à¸±à¸š...";;
          5)
            read -p "âš  à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸¥à¸š V2RayX (y/n)? " confirm
            if [[ "$confirm" == "y" ]]; then
              systemctl stop v2rayx
              systemctl disable v2rayx
              rm -f "$BIN_FILE"
              rm -rf "$INSTALL_DIR"
              rm -f "$SERVICE_FILE"
              systemctl daemon-reload
              echo "âœ… à¸¥à¸š V2RayX à¹à¸¥à¹‰à¸§"
              sleep 2
            fi;;
          0) break;;
          *) echo "âŒ à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡"; sleep 1;;
        esac
      done;;
    0)
      echo "ðŸ‘‹ à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸šà¹à¸¥à¹‰à¸§"
      exit;;
    *)
      echo "âŒ à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡"
      sleep 1;;
  esac
done
